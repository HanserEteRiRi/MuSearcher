<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MuSearcher</title>
	<link rel="stylesheet" href="../stylesheets/style.css">
	<link rel="stylesheet" href="../stylesheets/music.css">
    <link rel="stylesheet" href="../stylesheets/mv.css">
    <link rel="stylesheet" href="../stylesheets/upload.css">
	<link rel="stylesheet" href="../stylesheets/star.css">
</head>

<body>
	<header>
		<div class="container">
			<div class="logo">
				<a class="logo-item" href="javascript:history.back(-1)">
					<h2>MuSearcher</h2>
				</a>
			</div>
			<div class="avatar">
				<div class="uploadtop" onclick="jumptoupload()"><p class="inupload">上传歌曲</p></div>
				<div class="uploadtop" onclick="showStar()"><p class="inupload">我的收藏</p></div>
        		<div class="uploadtop-name"><p class="inupload-name" id="username"></p></div>
				<img class="avatar-img" src="../images/avatar-01.jpg">
			</div>
		</div>
	</header>
	<div class="star" id="star">
		<ul class="star-ul">
		  <li class="star-li">
			<div class="star-li-left">
			  <img src="../images/china.png" class="star-img">
			  <span class="star-name">歌曲名</span>
			</div>
			<span class="star-artist">歌手</span>
		  </li>
		</ul>
	  </div>
	<section class="slider1">
		<header1>
			<div class="back" href="javascript :;" onClick="javascript :history.back(-1);">
				<img src="../images/返回.svg">
			</div>
		</header1>
		<div class="cover">
            <div class="upload">
                <div class="title">上传歌曲</div>
				<div class="choosebox">
					<input type="file" id="choose-file" class="tip" name="选择文件"></input>
					<button type="button" id="comfirm">确认上传</button>
				</div>
            </div>
            
		</div>
		
	</section>
	<footer>
		<div class="btn-audio">
		  <div class="btn-cover">
			<img id="play-image" src="/images/cover.jpg">
		  </div>
		  <div style="margin-left:6px">
			<div id="play-song" class="btn-name">试着搜索一下吧~</div>
			<div id="play-singer" class="btn-singer">...</div>
		  </div>
		  <div class="audio">
			<audio controls="controls" id="audio">
			  <source id="play-source" src="" type="audio/mp3" />
			</audio>
		  </div>
		  <div class="footer-star" onclick="clicktostar()">收藏</div>
		</div>
	  </footer>
</body>

<script type="text/template" id="star-element">
    <li class="star-li" id={{id}} onclick="clicktoplay_star(this)">
      <div class="star-li-left">
        <img src="{{img}}" class="star-img">
        <span class="star-name">{{song}}</span>
      </div>
      <span class="star-artist">{{artist}}</span>
    </li>
  </script>

<script src="https://code.jquery.com/jquery-3.6.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../javascripts/alluse.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	function jumptoupload() {
        document.location.href = "upload";
    }
	$('#comfirm').click(()=>{
		if(localStorage.getItem("username") == "null") {
			alert("请先登录")
			return
		}
		let files = $('#choose-file')[0].files
		if (files.length <= 0) {
			console.log('请选择图片后再上传！')
		}
		let data = new FormData();
 		data.append('avatar', files[0]);
		$.ajax({
			type: "POST",
			url: addr+"/upload/",
			data: data,
			// 不修改 Content-Type 属性，使用 FormData 默认的 Content-Type 值
			contentType: false,
			// 不对 FormData 中的数据进行 url 编码，而是将 FormData 数据原样发送到服务器
			processData: false,
			success: res=>{
				alert(res.message)
				alert(res.filename)
			},
			error: err=>{
				alert(err)
			}
		})
	})

	function play(song) {
        document.getElementById("play-image").setAttribute("src", song.play_image);
        document.getElementById("play-source").setAttribute("src",  song.play_source + '?' + new Date().getTime());
        document.getElementById("play-singer").innerHTML = song.play_singer;
        document.getElementById("play-song").innerHTML = song.play_song;
        document.getElementById("audio").load();
        
        let data = { //歌曲点击信息传入服务器
            "songname": song.play_song,
            "songsrc": song.play_source,
            "singer": song.play_singer,
            "id": localStorage.getItem("id"),
            "username": localStorage.getItem("username")
        }

        $.ajax({
            type:"POST",
            url:addr+"/listeninfo",
            data:data,
            success:res=>{
                console.log(res)
            },
            error:err=>{
                console.log(err)
            }
        })
	}
	var old_playInfo = localStorage.getItem("play-info");
    if(old_playInfo != "undefined") {
      let oldplayInfo = JSON.parse(old_playInfo);
      play(oldplayInfo);
    }
</script>


</html>